name: Build Play! iOS with JIT
on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch: # Permet de lancer le build manuellement

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-15
        
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '26.1.1'
        
    - name: Install dependencies
      run: |
        brew install cmake ninja
        
    - name: Configure CMake for iOS
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -G Xcode \
          -DCMAKE_SYSTEM_NAME=iOS \          -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=14.0 \
          -DCMAKE_XCODE_ATTRIBUTE_DEVELOPMENT_TEAM="" \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_IOS=ON
        
    - name: Build for iOS
      run: |
        cd build
        xcodebuild \
          -project Play.xcodeproj \
          -scheme Play \
          -configuration Release \
          -arch arm64 \
          -sdk iphoneos \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -allowProvisioningUpdates
        
    - name: Create IPA structure
      run: |
        cd build
        mkdir -p Payload
        cp -r Release-iphoneos/Play.app Payload/
        
        # VÃ©rification et copie des entitlements
        if [ -f "../Source/ui_ios/Play.entitlements" ]; then
          cp ../Source/ui_ios/Play.entitlements Payload/Play.app/
          echo "âœ… Entitlements copied"
        fi
        
    - name: Package IPA
      run: |
        cd build
        zip -r Play-JIT.ipa Payload
        echo "ðŸ“¦ IPA created successfully"
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: Play-iOS-JIT
        path: build/Play-JIT.ipa
        retention-days: 30
