name: Build iOS

on: [push, pull_request]
jobs:
  build_ios:
    runs-on: macos-latest
    steps:
    - name: Set Xcode version
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 16.0 # Version plus stable pour GitHub Actions

    - name: Install dpkg
      run: brew install dpkg

    - name: Checkout
      uses: actions/checkout@v3
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Create Fake Tag for Versioning # SOLUTION POUR L'ERREUR DE VERSION
      run: |
        git tag v1.0.0
        git fetch --tags --force

    - name: Install Vulkan SDK
      run: |
        cd $RUNNER_WORKSPACE
        curl -L --output vulkansdk.zip https://sdk.lunarg.com/sdk/download/${VULKAN_SDK_VERSION}/mac/vulkansdk-macos-${VULKAN_SDK_VERSION}.zip?Human=true
        unzip vulkansdk.zip
        # Installation silencieuse
        sudo ./InstallVulkan-${VULKAN_SDK_VERSION}.app/Contents/MacOS/InstallVulkan-${VULKAN_SDK_VERSION} in --al --c com.lunarg.vulkan.ios
        echo "VULKAN_SDK=${HOME}/VulkanSDK/${VULKAN_SDK_VERSION}/iOS" >> $GITHUB_ENV
      env:
        VULKAN_SDK_VERSION: '1.3.268.0' # Version stable testée

    - name: Set SHORT_HASH
      run: echo "VALUE=${LONG_HASH:0:8}" >> $GITHUB_OUTPUT
      id: short_hash
      env:
        LONG_HASH: ${{ github.sha }}

    - name: Generate CMake Project
      run: |
        mkdir build
        cd build
        cmake .. -G"Xcode" -DCMAKE_TOOLCHAIN_FILE=../deps/Dependencies/cmake-ios/ios.cmake -DTARGET_IOS=ON -DCMAKE_PREFIX_PATH=$VULKAN_SDK -DBUILD_PSFPLAYER=ON -DBUILD_LIBRETRO_CORE=yes

    - name: Build
      run: |
        cd build
        cmake --build . --config Release -- -sdk iphoneos
        # Signature ad-hoc pour éviter les erreurs de provisionnement
        codesign -s "-" Source/ui_ios/Release-iphoneos/Play.app || true

    - name: Generate IPA
      run: |
        # Préparation manuelle si le script build_ipa.sh échoue encore
        mkdir -p installer_ios/Payload
        cp -r build/Source/ui_ios/Release-iphoneos/Play.app installer_ios/Payload/
        cd installer_ios
        zip -r Play.ipa Payload
        
    - name: Upload a Build Artifact ipa
      uses: actions/upload-artifact@v4
      with:
        name: Play_iOS_IPA
        path: installer_ios/Play.ipa

    - name: Upload a Build Artifact libretro
      uses: actions/upload-artifact@v4
      with:
        name: Play_iOS_libretro
        path: build/Source/ui_libretro/Release-iphoneos/play_libretro_ios.dylib
