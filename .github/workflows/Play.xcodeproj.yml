name: Build Play! iOS (JIT Enabled)

on:
  push:
  workflow_dispatch:

jobs:
  build_ios:
    runs-on: macos-latest
    steps:
      - name: Set Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.1.1'

      - name: Install Vulkan SDK
        run: |
          VULKAN_SDK_VERSION="1.4.304.1"
          curl -L -A "Mozilla/5.0" --show-error --output vulkansdk.zip "https://sdk.lunarg.com/sdk/download/$VULKAN_SDK_VERSION/mac/vulkansdk-macos-$VULKAN_SDK_VERSION.zip"
          unzip -q vulkansdk.zip
          sudo ./InstallVulkan-$VULKAN_SDK_VERSION.app/Contents/MacOS/InstallVulkan-$VULKAN_SDK_VERSION in --al --c com.lunarg.vulkan.ios
          echo "VULKAN_SDK=${HOME}/VulkanSDK/${VULKAN_SDK_VERSION}/iOS" >> $GITHUB_ENV

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Generate CMake (Cible iOS)
        run: |
          mkdir build
          cd build
          cmake .. -G"Xcode" \
            -DCMAKE_TOOLCHAIN_FILE=../deps/Dependencies/cmake-ios/ios.cmake \
            -DTARGET_IOS=ON \
            -DCMAKE_PREFIX_PATH=$VULKAN_SDK \
            -DUSE_VULKAN=ON \
            -DBUILD_PSFPLAYER=OFF

      - name: Build Play! for iPhone
        run: |
          cd build
          PROJECT_PATH=$(find . -name "Play.xcodeproj" | head -n 1)
          xcodebuild build \
            -project "$PROJECT_PATH" \
            -scheme Play \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO

          APP_PATH=$(find $(pwd) -name "Play.app" -type d | grep "Release-iphoneos" | head -n 1)
          echo "APP_FINAL_PATH=$APP_PATH" >> $GITHUB_ENV

      - name: Fix Bundle ID & Sign (Triple Vérification)
        run: |
          APP_DIR="${{ env.APP_FINAL_PATH }}"
          PLIST="$APP_DIR/Info.plist"
          
          # 1. Correction du Bundle ID (Supprime la variable ${MACOSX...} qui fait planter Sideloadly)
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.dmamss.play" "$PLIST"
          
          # 2. Permissions de fichiers et manettes (Essentiel pour jouer)
          /usr/libexec/PlistBuddy -c "Delete :UIFileSharingEnabled" "$PLIST" || true
          /usr/libexec/PlistBuddy -c "Add :UIFileSharingEnabled bool true" "$PLIST"
          /usr/libexec/PlistBuddy -c "Delete :LSSupportsOpeningDocumentsInPlace" "$PLIST" || true
          /usr/libexec/PlistBuddy -c "Add :LSSupportsOpeningDocumentsInPlace bool true" "$PLIST"

          # 3. Création du fichier Entitlements propre
          cat <<EOF > jit.entitlements
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>get-task-allow</key>
              <true/>
              <key>com.apple.developer.kernel.increased-memory-limit</key>
              <true/>
              <key>com.apple.developer.kernel.extended-virtual-addressing</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          # 4. Signature finale pour iPhone
          codesign --force --sign - --entitlements jit.entitlements "$APP_DIR"

      - name: Export IPA
        run: |
          mkdir Payload
          cp -r "${{ env.APP_FINAL_PATH }}" Payload/
          zip -r Play_Final_Fix.ipa Payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Play-iOS-Final
          path: Play_Final_Fix.ipa
