name: Build iOS Vulkan JIT-Ready

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build_ios:
    runs-on: macos-latest
    steps:
      # 1️⃣ Configuration Xcode (Version 26.1.1 pour iOS 18/19)
      - name: Set Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.1.1'

      # 2️⃣ Installation SDK Vulkan
      - name: Install Vulkan SDK
        run: |
          VULKAN_SDK_VERSION="1.4.304.1"
          curl -L -A "Mozilla/5.0" --show-error --output vulkansdk.zip "https://sdk.lunarg.com/sdk/download/$VULKAN_SDK_VERSION/mac/vulkansdk-macos-$VULKAN_SDK_VERSION.zip"
          unzip -q vulkansdk.zip
          sudo ./InstallVulkan-$VULKAN_SDK_VERSION.app/Contents/MacOS/InstallVulkan-$VULKAN_SDK_VERSION in --al --c com.lunarg.vulkan.ios
          echo "VULKAN_SDK=${HOME}/VulkanSDK/${VULKAN_SDK_VERSION}/iOS" >> $GITHUB_ENV

      # 3️⃣ Checkout du code
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Create Fake Tag
        run: git tag v1.0.0 || true

      # 4️⃣ Génération CMake
      - name: Generate CMake Project
        run: |
          mkdir build
          cd build
          cmake .. -G"Xcode" \
            -DCMAKE_TOOLCHAIN_FILE=../deps/Dependencies/cmake-ios/ios.cmake \
            -DTARGET_IOS=ON \
            -DCMAKE_PREFIX_PATH=$VULKAN_SDK \
            -DUSE_VULKAN=ON \
            -DBUILD_PSFPLAYER=OFF \
            -DBUILD_LIBRETRO_CORE=OFF

      # 5️⃣ Compilation
      - name: Build
        run: |
          cd build
          PROJECT_PATH=$(find . -name "Play.xcodeproj" -not -path "*/AutoTest/*" | head -n 1)
          
          xcodebuild build \
            -project "$PROJECT_PATH" \
            -scheme Play \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            -skipPackagePluginValidation \
            -skipMacroValidation

          APP_PATH=$(find $(pwd) -name "Play.app" -type d | grep "Release-iphoneos" | head -n 1)
          echo "APP_FINAL_PATH=$APP_PATH" >> $GITHUB_ENV

      # 6️⃣ Signature Robuste (Correction Dynamique)
      - name: Patch App and Sign (MeloNX JIT-Ready)
        run: |
          APP_DIR="${{ env.APP_FINAL_PATH }}"
          
          # On cherche tes fichiers là où ils sont sur ton repo
          INFO_PLIST_SRC=$(find . -path "*/ui_ios/Resources/Info.plist" | head -n 1)
          ENTITLEMENTS_SRC=$(find . -name "Play.entitlements" | head -n 1)
          
          echo "Utilisation de l'Info.plist : $INFO_PLIST_SRC"
          echo "Utilisation des Entitlements : $ENTITLEMENTS_SRC"

          # Injection de l'Info.plist
          cp "$INFO_PLIST_SRC" "$APP_DIR/Info.plist"
          
          # Signature forcée avec tes droits de débogage
          codesign --force --sign - --entitlements "$ENTITLEMENTS_SRC" "$APP_DIR"
          
          echo "Signature terminée avec succès."

      # 7️⃣ Création de l'IPA
      - name: Create IPA
        run: |
          mkdir -p Payload
          cp -r "${{ env.APP_FINAL_PATH }}" Payload/
          zip -r Play-JIT-Vulkan.ipa Payload
          
      # 8️⃣ Upload de l'artefact
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Play-JIT-Vulkan
          path: Play-JIT-Vulkan.ipa
